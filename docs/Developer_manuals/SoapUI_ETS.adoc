== SoapUI based Test Suites

=== Required knowledge
You should be familiar with:

* link:https://www.soapui.org/getting-started/your-first-soapui-project.html[SoapUI]
* link:http://groovy-lang.org/[Groovy]

include::SoapUI_ETS_GUI.adoc[]

=== Basics

link:http://www.soapui.org[SoapUI] is an open-source web service testing
application originally developed for testing service-oriented architectures
(SOA) and REST services. In ETF, it is extended via plugins and used to test
spatial web services.

Start the GUI with the batch file and click on 'File' and then on
'Create Empty project'. The name can be changed by right-clicking on the test
project and selecting 'Rename'.

SoapUI and ETF are using a slightly different terminology for test items, as the
following table shows.

[width="100%",options="header"]
|===
|  *SoapUI* | *ETF*
| Test Project | Executable Test Suite
| Test Suite | Test Module
| Test Case | Test Case
| Test Step | Test Step
| Test Assertion | Test Assertion
|===

Each project must possess properties which are used to provide metadata for ETF
and for passing user data into SoapUI, for example the service URL to test.

image:https://user-images.githubusercontent.com/13570741/27132670-fb733832-510f-11e7-941d-f328250e7fd0.png[]

Create a serviceEndpoint property in the "Custom Properties" tab and set a web service, for example an Atom service feed.

Properties on the Test project level can be referenced within SoapUI with the
expression `${#Project#PROPERTY}`.

To test whether a atom service feed is available, create new
SoapUI Test Suite, a Test Case and a HTTP Test Step. The Request URL ("Endpoint") of each
HTTP Test Step must be set to `${#Project#serviceEndpoint}`.

image:https://user-images.githubusercontent.com/13570741/27137321-eaecce0c-511d-11e7-8f0b-93361d0ba26b.png[]

Add a new Assertion with the plus sign, select 'Script' and 'Script Assertion'
and add the following content to check if the 'atom:feed' element exists in
the response:

[source,Groovy]
----
import de.interactive_instruments.etf.suim.*
Assert a = new Assert(messageExchange, context, log, Assert.INSPIRE_DS_NS)
a.exists("/atom:feed", "TR.missingFeedRootElement")
----

When you click on the green arrow to run the Assertion you will most likely get
this error:

image:https://user-images.githubusercontent.com/13570741/27138183-306dad32-5120-11e7-81de-71c8408922d7.png[]

The error is preprocessed for ETF and will, when SoapUI is run from within the
ETF, reference the 'TR.noDataReturned' translation and output the corresponding error message from the loaded Translation Template Collection (see the parameter etf.translation.template.collection.id below).

.Error message in the INSPIRE validator
=========================================
The error message in the INSPIRE validator would be (see the entry in the link:https://github.com/inspire-eu-validation/ets-repository/blob/master/include-metadata/TranslationTemplateBundle-EIDfadd4929-fa60-4781-b658-703bbfe3f4eb.xml#L13[Translation Template collection]):

> 'Expected a response but the service did not return any data. Verify that the used endpoint URL is correct and accessible from outside your organization. If the service requires authentication, then check that the correct credentials are used by the validator or verify that upstream firewalls/proxy servers do not prevent access.'
=========================================

#JFH: Every Translation Template Collection for SoapUI tests must at least have texts for all TR.xxx-messages that are defined in the predefined functions. The codes and their meaning needs to be listed in this manual along with the parameters of each message.#

This error occurs when no data has been received. Close the assertion (click on 'OK') and
click on the green arrow in the HTTP test step to execute the HTTP request and
execute the assertion against the response.

Depending on the received data, you may now get a passed assertion or get a error
with the 'TR.missingFeedRootElement' code.

=== Parameters and metadata properties

Properties are used to parameterize an Executable Test Suite ('Test Project' in SoapUI terminology) as well as to associate it with other resources of ETF like Tags, Test Object Types etc. The standard properties are described in the following table.

Description of standard properties
[width="100%",options="header"]
|===
|  *Property name* | *Description*
| serviceEndpoint | URL of the service to test
| authUser | optional username for authentication
| authPwd | optional password for authentication
| authMethod | only the value 'basic' for HTTP basic authentication is supported yet
| etf.ignore.properties | If properties are added in the SoapUI test project, which are not known to ETF,
it is assumed that these are parameters for the test suite and their input is required during the start of a test run.
This can be avoided by using this property, which can contain a list of property names that should not be interpreted as parameters.
| etf.tag.ids | EID reference to one or multiple link:#tags[Tags], separated by commas (whitespace is allowed)#
| etf.translation.template.collection.id | EID reference to a collection of link:#message-template-bundles[Translation Templates]
| etf.supported.test.object.type.ids | EID reference to one or more supported link:#soapui-test-object-types[Test Object Types], separated by commas (whitespace is allowed)#
| etf.dependency.ids | optional EID reference to one ore multiple Executable Test
Suites this test suite depends on, separated by commas (whitespace is allowed)
| etf.author | Name of the author of the test suite
| etf.last.editor | Name of the last editor of the test suite
| etf.creation.date | Date when the test suite was created as ISO 8601 string
| etf.last.update.date | Date when the test suite was updated as ISO 8601 string
| etf.version | Version of the test suite
|===

[[soapui-test-object-types]]
=== Test Object Types

==== Overview

This section lists all Test Object Types that are pre-defined in the SoapUI test driver.

For each Test Object Type, the following information is provided:

* a description
* the ID that must be used to reference the Test Object Type from an Executable Test Suite
* the parent Test Object Type in the hierarchy; for root nodes "-" is shown
* an XPath expression that can be used to detect a Test Object Type (for XML documents), if one exists

NOTE: In future versions of ETF it is planned that new Test Object Types may
be specified by a test developer defined and declared in XML in the
`include-metadata` directory.

#CP: Provide namespace lists like INSPIRE_DS_NS for other specs.#

[[tot-service]]
==== Web service
Any service with an interface using HTTP(S).

ID:: EID88311f83-818c-46ed-8a9a-cec4f3707365
Parent:: -
XPath:: -

[[tot-wfs]]
==== OGC Web Feature Service
A web service implementing the OGC Web Feature Service standard.

ID:: EIDdb12feeb-0086-4006-bc74-28f4fdef0171
Parent:: link:#tot-service[Web service]
XPath:: -

==== OGC Web Feature Service 2.0
A web service implementing OGC Web Feature Service 2.0 and OGC Filter Encoding 2.0.

ID:: EID9b6ef734-981e-4d60-aa81-d6730a1c6389
Parent:: link:#tot-wfs[OGC Web Feature Service]
XPath:: /*[local-name() = 'WFS_Capabilities' and namespace-uri() = 'http://www.opengis.net/wfs/2.0']

==== OGC Web Feature Service 1.1
A web service implementing OGC Web Feature Service 1.1 and OGC Filter Encoding 1.1.

ID:: EIDbc6384f3-2652-4c7b-bc45-20cec488ecd0
Parent:: link:#tot-wfs[OGC Web Feature Service]
XPath:: /*[local-name() = 'WFS_Capabilities' and namespace-uri() = 'http://www.opengis.net/wfs' and starts-with(@version,'1.1')]

==== OGC Web Feature Service 1.0.0
A web service implementing OGC Web Feature Service 1.0 and OGC Filter Encoding 1.0.0.

ID:: EID8a560e6a-043f-42ca-b0a3-31b115899593
Parent:: link:#tot-wfs[OGC Web Feature Service]
XPath:: /*[local-name() = 'WFS_Capabilities' and namespace-uri() = 'http://www.opengis.net/wfs' and @version='1.0.0']

[[tot-wms]]
==== OGC Web Map Service
A web service implementing the OGC Web Map Service standard.

ID:: EIDbae0df71-0553-438d-938f-028b53ba8aa7
Parent:: link:#tot-service[Web service]
XPath:: -

==== OGC Web Map Service 1.3.0
A web service implementing OGC Web Map Service 1.3.0.

ID:: EID9981e87e-d642-43b3-ad5f-e77469075e74
Parent:: link:#tot-wms[OGC Web Map Service]
XPath:: /*[local-name() = 'WMS_Capabilities' and namespace-uri() = 'http://www.opengis.net/wms' and @version = '1.3.0']

==== OGC Web Map Service 1.1.1
A web service implementing OGC Web Map Service 1.1.1.

ID:: EIDd1836a8d-9909-4899-a0bc-67f512f5f5ac
Parent:: link:#tot-wms[OGC Web Map Service]
XPath:: /*[local-name() = 'WMT_MS_Capabilities' and @version = '1.1.1']

[[tot-wmts]]
==== OGC Web Map Tile Service
A web service implementing the OGC Web Map Tile Service standard.

ID:: EID380b969c-215e-46f8-a4e9-16f002f7d6c3
Parent:: link:#tot-service[Web service]
XPath:: -

==== OGC Web Map Tile Service 1.0
A web service implementing OGC Web Map Tile Service 1.0.

ID:: EIDae35f7cd-86d9-475a-aa3a-e0bfbda2bb5f
Parent:: link:#tot-wmts[OGC Web Map Tile Service]
XPath:: /*[local-name() = 'Capabilities' and namespace-uri() = 'http://www.opengis.net/wmts/1.0']

[[tot-wcs]]
==== OGC Web Coverage Service
A web service implementing the OGC Web Coverage Service standard.

ID:: EIDdf841ddd-20d4-4551-8bc2-a4f7267e39e0
Parent:: link:#tot-service[Web service]
XPath:: -

==== OGC Web Coverage Service 2.0
A web service implementing OGC Web Coverage Service 2.0 and OGC Filter Encoding 2.0.

ID:: EIDdac58b52-3ffd-4eb5-96e3-64723d8f0f51
Parent:: link:#tot-wcs[OGC Web Coverage Service]
XPath:: /*[local-name() = 'Capabilities' and namespace-uri() = 'http://www.opengis.net/wcs/2.0']

==== OGC Web Coverage Service 1.1
A web service implementing OGC Web Coverage Service 1.1.

ID:: EID824596fa-ec04-4314-bf1a-f1e6ee119bf0
Parent:: link:#tot-wcs[OGC Web Coverage Service]
XPath:: /*[local-name() = 'Capabilities' and namespace-uri() = 'http://www.opengis.net/wcs/1.1']

==== OGC Web Coverage Service 1.0.0
A web service implementing OGC Web Coverage Service 1.0.

ID:: EID4d4bffed-0a18-43d3-98f4-f5e7055b02e4
Parent:: link:#tot-wcs[OGC Web Coverage Service]
XPath:: /*[local-name() = 'WCS_Capabilities' and namespace-uri() = 'http://www.opengis.net/wcs']

[[tot-sos]]
==== OGC Sensor Observation Service
A web service implementing the OGC Sensor Observation Service standard.

ID:: EIDadeb8bc4-c49b-4704-ba88-813aea5de31d
Parent:: link:#tot-service[Web service]
XPath:: -

==== OGC Sensor Observation Service 2.0
A web service implementing OGC Sensor Observation Service 2.0.

ID:: EIDf897f313-55f0-4e51-928a-0e9869f5a1d6
Parent:: link:#tot-sos[OGC Sensor Observation Service]
XPath:: /*[local-name() = 'Capabilities' and namespace-uri() = 'http://www.opengis.net/sos/2.0']

[[tot-csw]]
==== OGC Catalogue Service
A web service implementing the OGC Catalogue Service standard.

ID:: EID18bcbc68-56b9-4e8e-b0d1-90de324d0cc8
Parent:: link:#tot-service[Web service]
XPath:: -

==== OGC Catalogue Service 3.0
A web service implementing OGC Catalogue Service 3.0.

ID:: EIDb2a780a8-5bba-4780-bcd5-c8c909ac407d
Parent:: link:#tot-csw[OGC Catalogue Service]
XPath:: /*[local-name() = 'Capabilities' and namespace-uri() = 'http://www.opengis.net/cat/csw/3.0']

[[tot-csw-202]]
==== OGC Catalogue Service 2.0.2
A web service implementing OGC Catalogue Service 2.0.2.

ID:: EID4b0fb35d-10f0-47df-bc0b-6d4548035ae2
Parent:: link:#tot-csw[OGC Catalogue Service]
XPath:: /*[local-name() = 'Capabilities' and namespace-uri() = 'http://www.opengis.net/cat/csw/2.0.2']

==== OGC CSW-ebRIM Registry Service 1.0
A web service implementing the CSW-ebRIM Registry Service 1.0.

ID:: EID9b101002-e65e-4d96-ac45-fcb95ac6f507
Parent:: link:#tot-csw-202[OGC Catalogue Service 2.0.2]
XPath:: /*[local-name() = 'Capabilities' and namespace-uri() = 'http://www.opengis.net/cat/wfs/1.0']

==== Atom feed
A feed implementing the Atom Syndication Format that can be accessed using HTTP(S).

ID:: EID49d881ae-b115-4b91-aabe-31d5791bce52
Parent:: link:#tot-service[Web service]
XPath:: /*[local-name() = 'feed' and namespace-uri() = 'http://www.w3.org/2005/Atom']

=== Assertion library

The SoapUI extension library provides various functions for evaluating an XPath
expression against the received response. The functions are called on an
link:http://interactive-instruments.github.io/etf-sui-ae/groovydoc/index.html?de/interactive_instruments/etf/suim/Assert.html[Assert]
object:

[source,Groovy]
----
import de.interactive_instruments.etf.suim.*
Assert a = new Assert(messageExchange, context, log, Assert.INSPIRE_DS_NS)
----

The parameters `messageExchange`, `context` and `log` are pre-defined in the context of the assertion.

#JFH: add screenshot#

For further information see the
link:http://interactive-instruments.github.io/etf-sui-ae/groovydoc/index.html?de/interactive_instruments/etf/suim/Assert.html[Assert API documentation]

=== Tips for creating helpful test suites

#JFH: Be more explicit how to create useful tests, what challenges are typically encountered and how these can be addressed. Examples: Dependencies, technical test steps vs HTTP test steps, iterations based on an OGC web service response, etc#
